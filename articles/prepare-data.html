<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1. Example data preparation workflow • sdmclimateforecasts</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="1. Example data preparation workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmclimateforecasts</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/gettingstarted.html">Getting started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/prepare-data.html">1. Example data preparation workflow</a></li>
    <li><a class="dropdown-item" href="../articles/fit-model.html">2. Simple model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/detailed-diags.html">3. Detailed diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/changelog.html">changelog</a></li>
    <li><a class="dropdown-item" href="../articles/gettingstarted.html">Getting Started</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/changelog.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JessicaBolin/sdmclimateforecasts/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>1. Example data preparation workflow</h1>
                        <h4 data-toc-skip class="author">Robert
Wildermuth</h4>
            
            <h4 data-toc-skip class="date">2025-9-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JessicaBolin/sdmclimateforecasts/blob/master/vignettes/prepare-data.Rmd" class="external-link"><code>vignettes/prepare-data.Rmd</code></a></small>
      <div class="d-none name"><code>prepare-data.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="prepare-an-example-dataset-for-specied-distribution-modeling">Prepare an example dataset for specied distribution modeling<a class="anchor" aria-label="anchor" href="#prepare-an-example-dataset-for-specied-distribution-modeling"></a>
</h2>
<p>Here we prepare a sample dataset to create a species distribution
model for northern anchovy using the publicly available NOAA SWFSC
California Current Ecosystem Survey (CCES) acoustic-trawl sampling
observations.</p>
<div class="section level3">
<h3 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a>
</h3>
<div class="section level5">
<h5 id="libraries">Libraries<a class="anchor" aria-label="anchor" href="#libraries"></a>
</h5>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rerddap/" class="external-link">rerddap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/taiyun/corrplot" class="external-link">corrplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="helper-functions-to-extract-environmental-predictors">Helper functions to extract environmental predictors<a class="anchor" aria-label="anchor" href="#helper-functions-to-extract-environmental-predictors"></a>
</h5>
<p>These rely on environmental netcdfs, which are stored in different
places!</p>
<blockquote>
<p>Note these are hardcoded to Jessie’s repo - change when integrated to
package.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#source("/Users/admin/Documents/GitHub/CCSEcolForecasts/R/getROMS.R") # ROMS ocean model variables</span></span>
<span><span class="co"># source("./R/getMOM6_gridded.R") # MOM6 ocean model variables</span></span>
<span><span class="co">#source("/Users/admin/Documents/GitHub/CCSEcolForecasts/R/getCMEMS_l4chl.R") # CMEMS daily L4 chl</span></span>
<span><span class="co">#source("/Users/admin/Documents/GitHub/CCSEcolForecasts/R/getDistLand.R") # Distance to nearst land based on coast shp</span></span>
<span><span class="co">#source("/Users/admin/Documents/GitHub/CCSEcolForecasts/R/getBathym.R") # ETOPO bathymetry</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="step-1-clean-cces-data">Step 1: Clean CCES data<a class="anchor" aria-label="anchor" href="#step-1-clean-cces-data"></a>
</h3>
<p>First, we start by downloading and cleaning up the CCES data.
Download the latest SWFSC CPS trawl observations from ERDDAP</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataInfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rerddap/reference/info.html" class="external-link">info</a></span><span class="op">(</span><span class="st">'FRDCPSTrawlLHHaulCatch'</span>, url <span class="op">=</span> <span class="st">'https://coastwatch.pfeg.noaa.gov/erddap/'</span><span class="op">)</span></span>
<span><span class="va">dataInfo</span> <span class="co"># Metadata</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;ERDDAP(TM) info&gt; FRDCPSTrawlLHHaulCatch </span></span>
<span><span class="co">##  Base URL: https://coastwatch.pfeg.noaa.gov/erddap </span></span>
<span><span class="co">##  Dataset Type: tabledap </span></span>
<span><span class="co">##  Variables:  </span></span>
<span><span class="co">##      collection: </span></span>
<span><span class="co">##          Range: 2003, 4897 </span></span>
<span><span class="co">##      cruise: </span></span>
<span><span class="co">##          Range: 200307, 202506 </span></span>
<span><span class="co">##      haul: </span></span>
<span><span class="co">##          Range: 1, 247 </span></span>
<span><span class="co">##      haulback_time: </span></span>
<span><span class="co">##          Range: 1.05772524E9, 1.757495799E9 </span></span>
<span><span class="co">##          Units: seconds since 1970-01-01T00:00:00Z </span></span>
<span><span class="co">##      itis_tsn: </span></span>
<span><span class="co">##          Range: 48738, 16182800 </span></span>
<span><span class="co">##      latitude: </span></span>
<span><span class="co">##          Range: 28.6513, 54.3997 </span></span>
<span><span class="co">##          Units: degrees_north </span></span>
<span><span class="co">##      longitude: </span></span>
<span><span class="co">##          Range: -134.0793, -114.7928 </span></span>
<span><span class="co">##          Units: degrees_east </span></span>
<span><span class="co">##      presence_only: </span></span>
<span><span class="co">##      remaining_weight: </span></span>
<span><span class="co">##          Range: 0.0, 31818.0 </span></span>
<span><span class="co">##          Units: kg </span></span>
<span><span class="co">##      scientific_name: </span></span>
<span><span class="co">##      ship: </span></span>
<span><span class="co">##      ship_spd_through_water: </span></span>
<span><span class="co">##          Range: 0.0, 4.9 </span></span>
<span><span class="co">##          Units: knot </span></span>
<span><span class="co">##      stop_latitude: </span></span>
<span><span class="co">##          Range: 28.6548, 54.4157 </span></span>
<span><span class="co">##      stop_longitude: </span></span>
<span><span class="co">##          Range: -134.0325, -114.8483 </span></span>
<span><span class="co">##      subsample_count: </span></span>
<span><span class="co">##          Range: 0, 20610 </span></span>
<span><span class="co">##      subsample_weight: </span></span>
<span><span class="co">##          Range: 0.0, 2800.0 </span></span>
<span><span class="co">##          Units: kg </span></span>
<span><span class="co">##      surface_temp: </span></span>
<span><span class="co">##          Range: 0.0, 185.0 </span></span>
<span><span class="co">##          Units: degree C </span></span>
<span><span class="co">##      surface_temp_method: </span></span>
<span><span class="co">##      time: </span></span>
<span><span class="co">##          Range: 1.05772338E9, 1.757493994E9 </span></span>
<span><span class="co">##          Units: seconds since 1970-01-01T00:00:00Z</span></span></code></pre>
<p>Show the dataset columns (also see <a href="https://coastwatch.pfeg.noaa.gov/erddap/tabledap/FRDCPSTrawlLHHaulCatch.html" class="external-link uri">https://coastwatch.pfeg.noaa.gov/erddap/tabledap/FRDCPSTrawlLHHaulCatch.html</a>)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rerddap/reference/info.html" class="external-link">info</a></span><span class="op">(</span><span class="st">'FRDCPSTrawlLHHaulCatch'</span><span class="op">)</span><span class="op">$</span><span class="va">variables</span></span>
<span><span class="va">cols</span></span></code></pre></div>
<pre><code><span><span class="co">##             variable_name data_type                actual_range</span></span>
<span><span class="co">## 1              collection       int                  2003, 4897</span></span>
<span><span class="co">## 2                  cruise       int              200307, 202506</span></span>
<span><span class="co">## 3                    haul       int                      1, 247</span></span>
<span><span class="co">## 4           haulback_time    double 1.05772524E9, 1.757495799E9</span></span>
<span><span class="co">## 5                itis_tsn       int             48738, 16182800</span></span>
<span><span class="co">## 6                latitude     float            28.6513, 54.3997</span></span>
<span><span class="co">## 7               longitude     float        -134.0793, -114.7928</span></span>
<span><span class="co">## 8           presence_only    String                            </span></span>
<span><span class="co">## 9        remaining_weight     float                0.0, 31818.0</span></span>
<span><span class="co">## 10        scientific_name    String                            </span></span>
<span><span class="co">## 11                   ship    String                            </span></span>
<span><span class="co">## 12 ship_spd_through_water     float                    0.0, 4.9</span></span>
<span><span class="co">## 13          stop_latitude     float            28.6548, 54.4157</span></span>
<span><span class="co">## 14         stop_longitude     float        -134.0325, -114.8483</span></span>
<span><span class="co">## 15        subsample_count       int                    0, 20610</span></span>
<span><span class="co">## 16       subsample_weight     float                 0.0, 2800.0</span></span>
<span><span class="co">## 17           surface_temp     float                  0.0, 185.0</span></span>
<span><span class="co">## 18    surface_temp_method    String                            </span></span>
<span><span class="co">## 19                   time    double 1.05772338E9, 1.757493994E9</span></span></code></pre>
<p>Download the data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rerddap/reference/tabledap.html" class="external-link">tabledap</a></span><span class="op">(</span><span class="va">dataInfo</span>, fields <span class="op">=</span> <span class="va">cols</span><span class="op">$</span><span class="va">variable_name</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## info() output passed to x; setting base url to: https://coastwatch.pfeg.noaa.gov/erddap</span></span></code></pre>
<pre><code><span><span class="co">## Warning in set_units(temp_table, dds): NAs introduced by coercion</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;ERDDAP tabledap&gt; FRDCPSTrawlLHHaulCatch</span></span>
<span><span class="co">##    Path: [/tmp/Rtmp2aSXcz/R/rerddap/ec2bef583db1dd80f915a36408960a9b.csv]</span></span>
<span><span class="co">##    Last updated: [2026-01-16 21:31:44.229739]</span></span>
<span><span class="co">##    File size:    [3.65 mb]</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 19</span></span></span>
<span><span class="co">##   collection cruise  haul haulback_time itis_tsn latitude longitude</span></span>
<span><span class="co">##        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>    <span style="text-decoration: underline;">82</span>367     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>    <span style="text-decoration: underline;">82</span>371     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">159</span>643     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">161</span>729     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">161</span>828     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">168</span>586     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 12 more variables: presence_only &lt;chr&gt;, remaining_weight &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   scientific_name &lt;chr&gt;, ship &lt;chr&gt;, ship_spd_through_water &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   stop_latitude &lt;dbl&gt;, stop_longitude &lt;dbl&gt;, subsample_count &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   subsample_weight &lt;dbl&gt;, surface_temp &lt;dbl&gt;, surface_temp_method &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   time &lt;dttm&gt;</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-2-process-fields">Step 2: Process fields<a class="anchor" aria-label="anchor" href="#step-2-process-fields"></a>
</h3>
<p>NA values for sub-samples mean zeroes.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cps</span><span class="op">$</span><span class="va">subsample_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">subsample_count</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">cps</span><span class="op">$</span><span class="va">subsample_count</span><span class="op">)</span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">subsample_weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">subsample_weight</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">cps</span><span class="op">$</span><span class="va">subsample_weight</span><span class="op">)</span> <span class="co"># Use numbers and weights to show presence/absence </span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">subsample_count</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">cps</span><span class="op">$</span><span class="va">subsample_weight</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;ERDDAP tabledap&gt; FRDCPSTrawlLHHaulCatch</span></span>
<span><span class="co">##    Path: [/tmp/Rtmp2aSXcz/R/rerddap/ec2bef583db1dd80f915a36408960a9b.csv]</span></span>
<span><span class="co">##    Last updated: [2026-01-16 21:31:44.229739]</span></span>
<span><span class="co">##    File size:    [3.65 mb]</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 20</span></span></span>
<span><span class="co">##   collection cruise  haul haulback_time itis_tsn latitude longitude</span></span>
<span><span class="co">##        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>    <span style="text-decoration: underline;">82</span>367     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>    <span style="text-decoration: underline;">82</span>371     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">159</span>643     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">161</span>729     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">161</span>828     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>       <span style="text-decoration: underline;">2</span>003 <span style="text-decoration: underline;">200</span>307     1            <span style="color: #BB0000;">NA</span>   <span style="text-decoration: underline;">168</span>586     43.0     -<span style="color: #BB0000;">125.</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 13 more variables: presence_only &lt;chr&gt;, remaining_weight &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   scientific_name &lt;chr&gt;, ship &lt;chr&gt;, ship_spd_through_water &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   stop_latitude &lt;dbl&gt;, stop_longitude &lt;dbl&gt;, subsample_count &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   subsample_weight &lt;dbl&gt;, surface_temp &lt;dbl&gt;, surface_temp_method &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   time &lt;dttm&gt;, pres &lt;dbl&gt;</span></span></span></code></pre>
<p>Get mean longitude and latitude</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cps</span><span class="op">$</span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">stop_longitude</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">stop_latitude</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#cps$lon &lt;- rowMeans(cps[c("longitude", "stop_longitude")]) </span></span>
<span><span class="co">#cps$lat &lt;- rowMeans(cps[c("latitude", "stop_latitude")])</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">lon</span>, <span class="va">cps</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span> <span class="co"># Quick for any outlier locations</span></span></code></pre></div>
<p><img src="prepare-data_files/figure-html/CPStrawl5-1.png" class="r-plt" alt="" width="700"></p>
<p>Add a date column</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#names(cps)</span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="co"># Remove a few daytime samples</span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">hr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/hour.html" class="external-link">hour</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">time</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">hours</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="co"># times originally in UTC</span></span>
<span><span class="va">cps</span><span class="op">$</span><span class="va">dn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cps</span><span class="op">$</span><span class="va">hr</span> <span class="op">&lt;</span> <span class="fl">6.1</span> <span class="op">|</span> <span class="va">cps</span><span class="op">$</span><span class="va">hr</span> <span class="op">&gt;</span> <span class="fl">17.9</span>, <span class="st">"night"</span>, <span class="st">"day"</span><span class="op">)</span> </span>
<span><span class="va">cps1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">cps</span>, <span class="va">dn</span> <span class="op">==</span> <span class="st">"night"</span><span class="op">)</span>  </span>
<span><span class="va">cps1</span> <span class="op">&lt;-</span> <span class="va">cps1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cps1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "collection"             "cruise"                 "haul"                  </span></span>
<span><span class="co">##  [4] "haulback_time"          "itis_tsn"               "latitude"              </span></span>
<span><span class="co">##  [7] "longitude"              "presence_only"          "remaining_weight"      </span></span>
<span><span class="co">## [10] "scientific_name"        "ship"                   "ship_spd_through_water"</span></span>
<span><span class="co">## [13] "stop_latitude"          "stop_longitude"         "subsample_count"       </span></span>
<span><span class="co">## [16] "subsample_weight"       "surface_temp"           "surface_temp_method"   </span></span>
<span><span class="co">## [19] "time"                   "pres"                   "lon"                   </span></span>
<span><span class="co">## [22] "lat"                    "date"                   "hr"                    </span></span>
<span><span class="co">## [25] "dn"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cps1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   collection cruise haul haulback_time itis_tsn latitude longitude</span></span>
<span><span class="co">## 2       2003 200307    1            NA    82367  42.9816 -124.8413</span></span>
<span><span class="co">## 3       2003 200307    1            NA    82371  42.9816 -124.8413</span></span>
<span><span class="co">## 4       2003 200307    1            NA   159643  42.9816 -124.8413</span></span>
<span><span class="co">## 5       2003 200307    1            NA   161729  42.9816 -124.8413</span></span>
<span><span class="co">## 6       2003 200307    1            NA   161828  42.9816 -124.8413</span></span>
<span><span class="co">## 7       2003 200307    1            NA   168586  42.9816 -124.8413</span></span>
<span><span class="co">##   presence_only remaining_weight        scientific_name ship</span></span>
<span><span class="co">## 2             N              NaN               Teuthida   FR</span></span>
<span><span class="co">## 3             N              NaN Doryteuthis opalescens   FR</span></span>
<span><span class="co">## 4             N              NaN                Salpida   FR</span></span>
<span><span class="co">## 5             N              NaN        Sardinops sagax   FR</span></span>
<span><span class="co">## 6             N              NaN       Engraulis mordax   FR</span></span>
<span><span class="co">## 7             N              NaN  Trachurus symmetricus   FR</span></span>
<span><span class="co">##   ship_spd_through_water stop_latitude stop_longitude subsample_count</span></span>
<span><span class="co">## 2                    3.5       43.0006       -124.893               1</span></span>
<span><span class="co">## 3                    3.5       43.0006       -124.893               3</span></span>
<span><span class="co">## 4                    3.5       43.0006       -124.893               0</span></span>
<span><span class="co">## 5                    3.5       43.0006       -124.893               0</span></span>
<span><span class="co">## 6                    3.5       43.0006       -124.893               0</span></span>
<span><span class="co">## 7                    3.5       43.0006       -124.893               0</span></span>
<span><span class="co">##   subsample_weight surface_temp surface_temp_method                time pres</span></span>
<span><span class="co">## 2             0.01         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">## 3             0.03         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">## 4             0.10         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">## 5             0.01         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">## 6             0.05         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">## 7            26.00         13.3              bucket 2003-07-09 04:03:00    1</span></span>
<span><span class="co">##         lon     lat       date hr    dn</span></span>
<span><span class="co">## 2 -124.8672 42.9911 2003-07-09 21 night</span></span>
<span><span class="co">## 3 -124.8672 42.9911 2003-07-09 21 night</span></span>
<span><span class="co">## 4 -124.8672 42.9911 2003-07-09 21 night</span></span>
<span><span class="co">## 5 -124.8672 42.9911 2003-07-09 21 night</span></span>
<span><span class="co">## 6 -124.8672 42.9911 2003-07-09 21 night</span></span>
<span><span class="co">## 7 -124.8672 42.9911 2003-07-09 21 night</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert to wide format</span></span>
<span><span class="va">cpsMatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span><span class="va">cps1</span>, </span>
<span>                         names_from <span class="op">=</span> <span class="va">scientific_name</span>, </span>
<span>                         values_from <span class="op">=</span> <span class="va">pres</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cruise</span>, <span class="va">haul</span>, <span class="va">lon</span>, <span class="va">lat</span>, <span class="va">date</span>, <span class="va">dn</span><span class="op">)</span>, </span>
<span>                         values_fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## Warning: Values from `pres` are not uniquely identified; output will contain list-cols.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">•</span> Use `values_fn = list` to suppress this warning.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">•</span> Use `values_fn = {summary_fun}` to summarise duplicates.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">•</span> Use the following dplyr code to identify duplicates.</span></span>
<span><span class="co">##   {data} |&gt;</span></span>
<span><span class="co">##   dplyr::summarise(n = dplyr::n(), .by = c(cruise, haul, lon, lat, date, dn,</span></span>
<span><span class="co">##   scientific_name)) |&gt;</span></span>
<span><span class="co">##   dplyr::filter(n &gt; 1L)</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert NA to 0 </span></span>
<span><span class="va">cpsMatrix</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cpsMatrix</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cpsMatrix</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 276</span></span></span>
<span><span class="co">##   cruise  haul   lon   lat date       dn    Teuthida  `Doryteuthis opalescens`</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">200</span>307     1 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;dbl [1]&gt;</span> <span style="color: #949494;">&lt;dbl [1]&gt;</span>               </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">200</span>307     2 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;dbl [1]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">200</span>307     3 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;dbl [1]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> <span style="text-decoration: underline;">200</span>307     4 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;NULL&gt;</span>    <span style="color: #949494;">&lt;NULL&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> <span style="text-decoration: underline;">200</span>307     5 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;NULL&gt;</span>    <span style="color: #949494;">&lt;NULL&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> <span style="text-decoration: underline;">200</span>307     6 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 night <span style="color: #949494;">&lt;NULL&gt;</span>    <span style="color: #949494;">&lt;NULL&gt;</span>                  </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 268 more variables: Salpida &lt;list&gt;, `Sardinops sagax` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   `Engraulis mordax` &lt;list&gt;, `Trachurus symmetricus` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   Myctophidae &lt;list&gt;, `Merluccius productus` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   `Cololabis saira` &lt;list&gt;, `Oncorhynchus kisutch` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   `Scomber japonicus` &lt;list&gt;, `Icichthys lockingtoni` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   `Prionace glauca` &lt;list&gt;, Oncorhynchus &lt;list&gt;, `Thunnus alalunga` &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   Animalia &lt;list&gt;, `Clupea pallasii` &lt;list&gt;, `Alosa sapidissima` &lt;list&gt;, …</span></span></span></code></pre>
<blockquote>
<p>Jessie: getting warnings when running <code>cpsMatrix</code> code.
Check with Rob.</p>
</blockquote>
<p>Add a few other useful columns</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpsMatrix</span><span class="op">$</span><span class="va">survey</span> <span class="op">&lt;-</span> <span class="st">"cps"</span></span></code></pre></div>
<p>Subset to just anchovy</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpsAnch</span> <span class="op">&lt;-</span> <span class="va">cpsMatrix</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"survey"</span>, <span class="st">"cruise"</span>, <span class="st">"haul"</span>, <span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"date"</span>, <span class="st">"Engraulis mordax"</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cpsAnch</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cpsAnch</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"anchPA"</span></span>
<span></span>
<span><span class="co"># Add a unique ID</span></span>
<span><span class="va">cpsAnch</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cpsAnch</span><span class="op">)</span><span class="op">)</span> <span class="co"># used as 'obs' bellow</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cpsAnch</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">##   survey cruise  haul   lon   lat date       anchPA       id</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> cps    <span style="text-decoration: underline;">200</span>307     1 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;dbl [1]&gt;</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> cps    <span style="text-decoration: underline;">200</span>307     2 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;NULL&gt;</span>        2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> cps    <span style="text-decoration: underline;">200</span>307     3 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;NULL&gt;</span>        3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> cps    <span style="text-decoration: underline;">200</span>307     4 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;NULL&gt;</span>        4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> cps    <span style="text-decoration: underline;">200</span>307     5 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;NULL&gt;</span>        5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> cps    <span style="text-decoration: underline;">200</span>307     6 -<span style="color: #BB0000;">125.</span>  43.0 2003-07-09 <span style="color: #949494;">&lt;NULL&gt;</span>        6</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-3-pull-phys--covariate-data">Step 3: Pull phys. covariate data<a class="anchor" aria-label="anchor" href="#step-3-pull-phys--covariate-data"></a>
</h3>
<p>Next, we pull together physical covariate data from other public
online databases.</p>
<blockquote>
<p>Note, Jessie cannot run the below as don’t have Hinchliffe dataset in
repo.</p>
</blockquote>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load datasets: these currently live in project ./data</span></span>
<span><span class="co"># coast &lt;- sf::read_sf("./data/EPOCoast60_noGI.shp") # The coast shp</span></span>
<span><span class="va">coast</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">coastline</span><span class="op">(</span><span class="op">)</span> <span class="co">#!!RW: have to check if this will work for demonstration purposes</span></span>
<span><span class="va">anch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"/Users/admin/Documents/GitHub/CCSEcolForecasts/data/Hinchliffe_CSNA_timeseries_19652023.csv"</span><span class="op">)</span> <span class="co"># Anchovy SSB from Hincliffe et al. 2025</span></span>
<span></span>
<span><span class="co"># To get a "persistence" forecast, we extract environmental variables from the year before the sampling date</span></span>
<span><span class="co"># lag = 0 in the function extracts variables at the sampling date, lag = 1 extracts from the year before</span></span>
<span><span class="co"># This is clunky but here I'm running the function twice to get lag = 0 and lag = 1, then joining the outputs</span></span>
<span><span class="co"># Careful with lag &gt; 0, could potentially give dates outside the temporal range of environmental datasets</span></span>
<span><span class="co">#!!RW: generalize extractEnvVars() to specifiy which covariates to pull in</span></span>
<span><span class="co">#      - OR just call the specific get*() fxns to make things more explicit</span></span>
<span><span class="va">envExtractLag0</span> <span class="op">&lt;-</span> <span class="fu">extractEnvVars</span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, lag <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">envExtractLag1</span> <span class="op">&lt;-</span> <span class="fu">extractEnvVars</span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Adjust colnames: clunky</span></span>
<span><span class="co">#!!RW: Clean this up</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">envExtractLag1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">envExtractLag1</span><span class="op">)</span>, <span class="st">"_lag1"</span><span class="op">)</span> <span class="co"># Adjust with lag number</span></span>
<span><span class="co"># Figure out col index where environmental covariates start</span></span>
<span><span class="va">startCol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">envExtract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">envExtractLag0</span>, <span class="va">envExtractLag1</span><span class="op">[</span>, <span class="va">startCol</span><span class="op">:</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">envExtractLag1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Save the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">envExtract</span>, <span class="st">"./data/combinedBioObs_envExtracted.rds"</span><span class="op">)</span></span></code></pre></div>
<p><em>For now, load output above from local file</em></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"combinedBioObs_envExtracted.rds"</span>,</span>
<span>                 package <span class="op">=</span> <span class="st">"sdmclimateforecasts"</span><span class="op">)</span></span>
<span><span class="va">envExtract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">envExtract</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   survey cruise haul       lon      lat       date anchPA id      ild      sst</span></span>
<span><span class="co">## 1    cps 200307    1 -124.8672 42.99110 2003-07-09      1  1 2.404042 12.67080</span></span>
<span><span class="co">## 2    cps 200307    2 -124.9490 43.00345 2003-07-09      0  2 2.404042 12.67080</span></span>
<span><span class="co">## 3    cps 200307    3 -125.0348 43.01560 2003-07-09      0  3 3.228197 12.79822</span></span>
<span><span class="co">## 4    cps 200307    4 -125.1154 43.00045 2003-07-09      0  4 3.503623 13.27315</span></span>
<span><span class="co">## 5    cps 200307    5 -125.2075 43.00005 2003-07-09      0  5 3.716197 13.91262</span></span>
<span><span class="co">## 6    cps 200307    6 -125.3057 43.00300 2003-07-09      0  6 3.734344 14.40529</span></span>
<span><span class="co">##      sst_sd     ssh_sd         eke    logEKE       chl      logChl distLand</span></span>
<span><span class="co">## 1 1.0602433 0.01866543 0.027121617 -3.607424 0.9818046 -0.01836293 29629.38</span></span>
<span><span class="co">## 2 1.0602433 0.01866543 0.039371376 -3.234716 0.7811583 -0.24697752 36043.10</span></span>
<span><span class="co">## 3 0.9719992 0.02196990 0.009381834 -4.668980 0.7359316 -0.30661811 42827.86</span></span>
<span><span class="co">## 4 0.8266193 0.02738416 0.006201829 -5.082911 0.9444131 -0.05719161 48125.07</span></span>
<span><span class="co">## 5 0.7526832 0.03357841 0.011109728 -4.499934 1.1147090  0.10859338 55161.98</span></span>
<span><span class="co">## 6 0.6279386 0.04007801 0.030783334 -3.480782 1.0380287  0.03732344 62894.87</span></span>
<span><span class="co">##       bathym year anchssb ild_lag1 sst_lag1 sst_sd_lag1 ssh_sd_lag1   eke_lag1</span></span>
<span><span class="co">## 1  -254.0408 2003  466616 6.104747 14.48057   1.2994136  0.01999982 0.01568088</span></span>
<span><span class="co">## 2  -761.1837 2003  466616 6.104747 14.48057   1.2994136  0.01999982 0.01264101</span></span>
<span><span class="co">## 3 -1279.6939 2003  466616 6.630548 15.16734   1.0764430  0.02447072 0.03796448</span></span>
<span><span class="co">## 4 -1809.4694 2003  466616 7.330258 15.66488   0.8026699  0.02746283 0.06900047</span></span>
<span><span class="co">## 5 -2324.0000 2003  466616 7.648054 15.94528   0.6320010  0.02865770 0.10133756</span></span>
<span><span class="co">## 6 -3067.7959 2003  466616 7.912380 16.18897   0.5238957  0.02855562 0.11550667</span></span>
<span><span class="co">##   logEKE_lag1   chl_lag1 logChl_lag1 distLand_lag1 bathym_lag1 year_lag1</span></span>
<span><span class="co">## 1   -4.155313 12.6281660  2.53592971      29629.38   -254.0408      2002</span></span>
<span><span class="co">## 2   -4.370809  7.4417920  2.00711168      36043.10   -761.1837      2002</span></span>
<span><span class="co">## 3   -3.271104  4.0881181  1.40808475      42827.86  -1279.6939      2002</span></span>
<span><span class="co">## 4   -2.673642  1.3723352  0.31651382      48125.07  -1809.4694      2002</span></span>
<span><span class="co">## 5   -2.289298  0.9124697 -0.09160038      55161.98  -2324.0000      2002</span></span>
<span><span class="co">## 6   -2.158427  1.0364990  0.03584867      62894.87  -3067.7959      2002</span></span>
<span><span class="co">##   anchssb_lag1</span></span>
<span><span class="co">## 1       339465</span></span>
<span><span class="co">## 2       339465</span></span>
<span><span class="co">## 3       339465</span></span>
<span><span class="co">## 4       339465</span></span>
<span><span class="co">## 5       339465</span></span>
<span><span class="co">## 6       339465</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="step-4-relate-env-var--to-anchovy-obs">Step 4: Relate env var. to anchovy obs<a class="anchor" aria-label="anchor" href="#step-4-relate-env-var--to-anchovy-obs"></a>
</h3>
<p>We can investigate how these variables relate to the anchovy
observations in the CCES dataset.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot example time series</span></span>
<span><span class="va">envExtract</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">sst</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">anchPA</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 222 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_point()`).</span></span></code></pre>
<p><img src="prepare-data_files/figure-html/getCovars10-1.png" class="r-plt" alt="" width="700"></p>
<p>Plot correlations</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corrMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">envExtract</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, <span class="va">anchPA</span>, <span class="va">ild</span>, <span class="va">sst</span>, <span class="va">eke</span>, <span class="va">chl</span>, <span class="va">bathym</span>, <span class="va">anchssb</span><span class="op">)</span>, use <span class="op">=</span> <span class="st">"pairwise.complete.obs"</span><span class="op">)</span></span>
<span><span class="va">pTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/cor.mtest.html" class="external-link">cor.mtest</a></span><span class="op">(</span><span class="va">envExtract</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, <span class="va">anchPA</span>, <span class="va">ild</span>, <span class="va">sst</span>, <span class="va">eke</span>, <span class="va">chl</span>, <span class="va">bathym</span>, <span class="va">anchssb</span><span class="op">)</span>, </span>
<span>                   alternative <span class="op">=</span> <span class="st">"two.sided"</span>, </span>
<span>                   method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span><span class="va">corrMat</span>, p.mat <span class="op">=</span> <span class="va">pTest</span><span class="op">$</span><span class="va">p</span>, sig.level <span class="op">=</span> <span class="fl">0.05</span>, insig <span class="op">=</span> <span class="st">"blank"</span>,</span>
<span>         order <span class="op">=</span> <span class="st">'hclust'</span>, hclust.method <span class="op">=</span> <span class="st">"ward.D2"</span>, <span class="co">#"centroid", #"single", #</span></span>
<span>         tl.col <span class="op">=</span> <span class="st">'black'</span>, type <span class="op">=</span> <span class="st">"lower"</span>,</span>
<span>         cl.ratio <span class="op">=</span> <span class="fl">0.1</span>, tl.srt <span class="op">=</span> <span class="fl">45</span>, tl.cex <span class="op">=</span> <span class="fl">0.6</span>, <span class="co">#mar = c(0.1, 0.1, 0.1, 0.1), </span></span>
<span>         addrect <span class="op">=</span> <span class="fl">6</span>, rect.col <span class="op">=</span> <span class="st">"green"</span>, diag <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="prepare-data_files/figure-html/getCovars11-1.png" class="r-plt" alt="" width="700"></p>
<p>Biplots of covariate space</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">envExtract</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">anchPA</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ild</span>, y <span class="op">=</span> <span class="va">sst</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 24 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_point()`).</span></span></code></pre>
<p><img src="prepare-data_files/figure-html/getCovars12-1.png" class="r-plt" alt="" width="700"></p>
<p>We will create a set of training and test subsets of the
observational data for later use.</p>
<p>TBD.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jessica A. Bolin, Rob Wildemuth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
